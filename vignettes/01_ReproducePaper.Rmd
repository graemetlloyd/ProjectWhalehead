---
title: "01_Replication"
author: "April Wright & Graeme Lloyd"
date: "11/11/2019"
output: html_document
---

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = "../")
```

Before you begin, install the package with:

```{r, eval=FALSE}
devtools::install_github("graemetlloyd/ProjectWhalehead")
devtools::install_github("graemetlloyd/metatree")
devtools::install_github("graemetlloyd/Claddis")
devtools::install_github("graemetlloyd/hypRspace")
```

Now, we'll load libraries and ensure we're in the right place (`getwd` should return "ProjectWhalehead"'s location on your machine).

```{r, eval=FALSE }
library(Whalehead)
library(metatree)
library(Claddis)
getwd()
```


To reproduce the paper, you will make sure all the tips have both data and metadata. If they do, you will get ages from PBDB.

```{r eval=FALSE}

Whalehead::build_ages("../Data/NEXUS/", "../Data/XML/", "../Data/Ages")
```

Then, you will check the datasets to make sure all the tips have names and those names can be synchronized across data sources. Also, disregard any sets with missing tip ages.

```{r eval=FALSE}
remove_unreconciled("../Data/XML")
remove_missing_tips("../Data/XML")
```

We have included the scripts to estimate phylogenetic trees from the data. This is time-intensive and we will not reproduce this analysis in this notebook. We will skip straight to making the stratigraphic congruence output.

```{r eval=FALSE}
make_strat_congruence("../Data/RevBayesOutput/", "../Data/NEXUS/", "../Data/Ages/", "../Data/MPTS/", "revbayes_output", "parsimony_out")
```

Next, we can summarize the data in a few ways.  To make table two:

```{r eval=FALSE}
fi <- list.files("data/StratCongruenceResults/")
sapply(fi, summary_stat)
```

Or your could summarize all of the files at once:

```{r eval=FALSE}
summarize_medians(user.path = "data/StratCongruenceResults/")
```

Or make violin and box plots of them:

```{r eval=FALSE}
files <- list.files(path = user.path, pattern = "*.txt", full.names = TRUE, recursive = FALSE)
dir.create("ViolinPlots")
lapply(files, makeViolins)
dir.create("boxPlots")
lapply(files, makeBoxplot)
```

Finally, you can make our custom treespace visuals. These are compute intensive, so only one is shown here. The functions to do this are modified from the R package `RWTY` and depend on RWTY being installed.

```{r eval=FALSE}
library(rwty)
#dir.create("data/TreeSpacePlots/")
trees  <- list.files(path = "Data/CombinedTrees", pattern = "*.nex", full.names = TRUE, recursive = FALSE)
strats  <- list.files(path = "Data/StratCongruenceResults/InputTreeResults", pattern = "*.txt", full.names = TRUE, recursive = FALSE)

for (i in 1:length(trees)){
  print(trees[i])
  print(strats[i])
  custom_plots(CombinedTrees = trees[i], StratFile =  strats[i], ext_columns = c("MIG", "Bayes"))
}

# custom_plots(CombinedTrees = "Data/CombinedTrees/Aguirre-Fernandez_etal_2009a.nex", StratFile =  "Data/StratCongruenceResults/InputTreeResults/Aguirre-Fernandez_etal_2009a.txt", ext_columns = c("MIG", "Bayes"))
```
